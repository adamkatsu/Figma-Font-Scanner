<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: blob: https://fonts.google.com https://fonts.gstatic.com https://gwfh.mranftl.com https://www.googleapis.com;">

  <style>
    * { box-sizing: border-box; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Inter, sans-serif; 
      padding: 0; 
      margin: 0;
      color: #000; 
      font-size: 13px; 
      background: #fff;
      line-height: 1.5;
    }
    
    /* Header Section */
    .header-section {
      text-align: center;
      padding: 24px 20px;
      margin: 8;
      border-radius: 8px;
      background-color: #F5F5F5;
    }
    
    h2 { 
      margin: 0 0 0 0; 
      font-size: 28px; 
      font-weight: 700;
      letter-spacing: -0.5px;
      color: #000;
    }
    
    .header-subtitle {
      font-size: 13px;
      color: #666;
      margin: 0 0 16px 0;
      font-weight: 400;
    }
    
    /* Global Buttons */
    button { 
      cursor: pointer; 
      border: none; 
      border-radius: 8px; 
      font-weight: 500; 
      transition: all 0.15s ease;
      font-family: inherit;
      font-size: 13px;
    }
    
    .primary-btn {
      background: #000; 
      color: #fff; 
      padding: 14px 32px; 
      font-weight: 600;
      letter-spacing: -0.1px;
      border-radius: 8px;
      font-size: 14px;
      display: inline-block;
      min-width: 200px;
    }
    .primary-btn:hover { 
      background: #333; 
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .primary-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    
    /* Headers */
    .section-header {
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      margin: 0 0 0 0; 
      padding-bottom: 4px;
    }
    
    h3 { 
      margin: 0; 
      font-size: 11px; 
      text-transform: uppercase; 
      color: #666;
      font-weight: 600;
    }
    
    /* Disclaimers for sections */
    .header-disclaimer {
      font-size: 11px; 
      color: #999; 
      margin-top: 6px; 
      font-weight: 400;
      text-transform: none;
      letter-spacing: 0;
    }

    /* List Items */
    .list { 
      list-style: none; 
      padding: 0; 
      margin: 0 0 24px 0;
    }
    
    .item-wrapper { 
      transition: background 0.15s ease;
    }
    
    .item-wrapper:hover {
      background: #FAFAFA;
    }
    
    .item-wrapper:last-child {
      border-bottom: none;
    }
    
    .item {
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      padding: 8px 8px; 
      border: 1px solid #F7F7F7;
      border-radius: 8px;
      margin-top: 4px;
      background-color: #ffffff;
      transition: all 0.15s ease;
    }

    .item:hover {
      background-color: #f7f7f7;
    }
    
    .item.selected {
      background-color: #000;
      border-color: #000;
    }
    
    .item.selected .font-name {
      color: #fff;
    }
    
    .item.selected .font-name::before {
      color: #fff;
    }
    
    .item.selected .badge-missing {
      background: #fff;
      color: #000;
    }
    
    .item.selected .ext-link {
      color: #fff;
    }
    
    .item.selected .ext-link:hover {
      color: #fff;
      background: rgba(255, 255, 255, 0.2);
    }

    .font-name { 
      font-weight: 500; 
      font-size: 14px; 
      display: flex; 
      align-items: center; 
      gap: 0px;
      color: #000;
      letter-spacing: -0.2px;
      position: relative;
      padding-left: 12px;
      transition: color 0.15s ease;
    }
    
    .font-name:hover {
      color: #333;
    }
    
    .font-name::before {
      content: '•';
      position: absolute;
      left: 0;
      color: #000;
      font-size: 16px;
      line-height: 1;
    }
    
    .badge-missing { 
      background: #000; 
      color: #fff; 
      font-size: 10px; 
      padding: 3px 8px; 
      border-radius: 4px;
      font-weight: 500;
      letter-spacing: 0.3px;
      text-transform: uppercase;
    }
    
    /* Action Buttons Row */
    .actions { 
      display: flex; 
      gap: 6px; 
      align-items: center; 
    }
    
    .icon-btn {
      background: transparent; 
      border: 1px solid #E5E5E5; 
      color: #000;
      padding: 6px 12px; 
      font-size: 12px; 
      border-radius: 4px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .icon-btn svg {
      display: block;
    }
    
    .icon-btn:hover { 
      background: #000; 
      color: #fff;
      border-color: #000;
    }
    
    .icon-btn.active { 
      background: #000; 
      border-color: #000; 
      color: #fff; 
    }

    /* External Links */
    .link-group { 
      display: flex; 
      gap: 4px; 
    }
    
    .ext-link { 
      text-decoration: none; 
      color: #666; 
      font-weight: 400; 
      font-size: 16px;
      padding: 8px;
      border-radius: 4px;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      background: transparent;
    }
    
    .ext-link:hover { 
      color: #000;
      background: #e9e9e9;
    }
    
    .ext-link svg {
      width: 14px;
      height: 14px;
    }
    
    .ext-link.replace-active {
      color: #000;
      background: #e9e9e9;
    }
    
    /* Tooltip */
    .ext-link {
      position: relative;
    }
    
    .ext-link::before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-8px);
      background: #fff;
      color: #000;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 1001;
      margin-bottom: 4px;
      border: 1px solid #E5E5E5;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .ext-link::after {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-8px);
      border: 4px solid transparent;
      border-top-color: #fff;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 1002;
      margin-bottom: -4px;
      filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.05));
    }
    
    .ext-link:hover::before,
    .ext-link:hover::after {
      opacity: 1;
    }
    
    .ext-link:hover::before {
      transform: translateX(-50%) translateY(0);
    }
    
    .ext-link:hover::after {
      transform: translateX(-50%) translateY(0);
    }

    /* REPLACEMENT MODAL CSS */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .modal-overlay.show {
      display: flex;
      opacity: 1;
    }
    
    .modal-container {
      background: #fff;
      border-radius: 8px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      position: relative;
      transform: scale(0.95);
      transition: transform 0.2s ease;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }
    
    .modal-overlay.show .modal-container {
      transform: scale(1);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .modal-title {
      font-size: 16px;
      font-weight: 600;
      color: #000;
      margin: 0;
      text-transform: none;
    }
    
    .modal-close {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      border-radius: 4px;
      transition: all 0.15s ease;
    }
    
    .modal-close:hover {
      background: #F5F5F5;
      color: #000;
    }
    
    .modal-close svg {
      width: 16px;
      height: 16px;
    }
    
    .replace-row { 
      display: flex; 
      gap: 8px; 
      position: relative; 
    }
    
    .input-wrapper { 
      position: relative; 
      flex-grow: 1; 
    }

    .replace-input {
      width: 100%; 
      box-sizing: border-box;
      padding: 10px 12px; 
      border: 1px solid #E5E5E5; 
      border-radius: 6px; 
      font-size: 13px;
      background: #fff;
      color: #000;
      font-family: inherit;
      transition: all 0.15s ease;
    }
    
    .replace-input:focus {
      outline: none;
      border-color: #000;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.05);
    }
    
    .replace-input::placeholder {
      color: #999;
    }

    /* CUSTOM SCROLLABLE LIST */
    .suggestions-list {
      position: absolute; 
      top: 100%; 
      left: 0; 
      right: 0;
      background: #fff; 
      border: 1px solid #E5E5E5; 
      border-top: none;
      border-radius: 0 0 6px 6px;
      max-height: 200px; 
      overflow-y: auto;
      z-index: 10001; 
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-top: -1px;
    }
    
    .suggestions-list.show { 
      display: block; 
    }
    
    .suggestion-item { 
      padding: 10px 12px; 
      cursor: pointer; 
      border-bottom: 1px solid #e9e9e9;
      color: #000;
      font-size: 13px;
      transition: background 0.1s ease;
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .suggestion-item:hover { 
      background: #FAFAFA; 
    }

    .apply-btn { 
      background: #000; 
      color: #fff; 
      padding: 10px 20px; 
      white-space: nowrap;
      font-weight: 500;
      border-radius: 4px;
    }
    
    .apply-btn:hover { 
      background: #333; 
    }
    
    .apply-btn:active {
      transform: scale(0.98);
    }

    .loader { 
      display: none; 
      text-align: center; 
      margin: 24px 0; 
      color: #666;
      font-size: 13px;
    }
    
    /* Container */
    #resultsContainer {
      padding: 0 0 0 0;
    }
    
    .content-wrapper {
      min-height: calc(100vh - 200px);
    }
    
    /* Empty state */
    #resultsContainer p {
      margin: 8px 0;
      color: #999;
      font-size: 13px;
      text-align: center;
    }
    
    /* Main container padding */
    body > *:not(script) {
      padding-left: 8px;
      padding-right: 8px;
    }
    
    /* Footer Section */
    .footer-section {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-top: 1px solid #E5E5E5;
      padding: 12px 20px;
      text-align: center;
      font-size: 11px;
      color: #999;
      z-index: 100;
    }
    
    .footer-content {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 3px;
      flex-wrap: wrap;
    }
    
    .footer-link {
      color: #000;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.15s ease;
    }
    
    .footer-link:hover {
      color: #666;
    }
    
    .footer-version {
      color: #999;
    }
    
    .footer-separator {
      color: #E5E5E5;
    }
    
    /* Content wrapper to prevent footer overlap */
    .content-wrapper {
      padding: 8px 8px 32px 8px;
    }
    
    /* Notification Toast */
    .notification-toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #fff;
      color: #000;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 500;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
      z-index: 10000;
      opacity: 0;
      transition: all 0.3s ease;
      display: inline-block;
      width: auto;
      min-width: fit-content;
      max-width: calc(100% - 32px);
      pointer-events: none;
      text-align: center;
      border: 1px solid #E5E5E5;
      white-space: nowrap;
    }
    
    .notification-toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
      pointer-events: auto;
    }
    
    .notification-toast .notification-count {
      font-weight: 600;
      margin-right: 4px;
    }
  </style>
</head>
<body>

  <div class="header-section">
  <h2>Font Scanner</h2>
    <p class="header-subtitle">Scan and manage fonts in your Figma designs</p>
    <button id="scanBtn" class="primary-btn">Scan Fonts</button>
  </div>
  
  <div class="content-wrapper">
  <div id="loader" class="loader">Scanning...</div>
  <div id="resultsContainer"></div>
  </div>
  
  <div class="footer-section">
    <div class="footer-content">
      <span class="footer-version">v1.0.0</span>
      <span class="footer-separator">•</span>
      <span>Made with <span style="color: #ff6b6b;">♥</span> by</span>
      <a href="https://slabpixel.com" target="_blank" class="footer-link">SlabPixel</a>
    </div>
  </div>
  <div id="notificationToast" class="notification-toast"></div>
  
  <!-- Replace Modal -->
  <div id="replaceModal" class="modal-overlay">
    <div class="modal-container" id="modalContainer">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Replace Font</h3>
        <button class="modal-close" id="modalClose">
          <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      <div id="modalContent"></div>
    </div>
  </div>

  <script>
    const API_KEY = 'AIzaSyBZqOric7hC8x6zLV-Xt-X6VS0g6NsoA6k'; 
    let systemFontsGlobal = []; 
    let selectedFontItem = null; 

    // KEYWORDS TO DETECT ICON FONTS
    const ICON_KEYWORDS = [
      'awesome', 'icon', 'symbol', 'glyph', 'icomoon', 'entypo', 'dingbat', 'ionicons', 'material icons', 'material symbols'
    ];

    function performScan() {
      document.getElementById('resultsContainer').innerHTML = '';
      document.getElementById('loader').style.display = 'block';
      // Clear selected state
      if (selectedFontItem) {
        selectedFontItem.classList.remove('selected');
        selectedFontItem = null;
      }
      parent.postMessage({ pluginMessage: { type: 'scan-layers' } }, '*');
    }
    
    document.getElementById('scanBtn').onclick = performScan;
    
    // Automatically scan on plugin open
    performScan();

    onmessage = async (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'scan-result') {
        if (msg.systemFonts) systemFontsGlobal = msg.systemFonts;
        await processFonts(msg.fonts || [], msg.missingFonts || [], msg.fontCounts || []);
      } else if (msg.type === 'notification') {
        showNotification(msg.message, msg.count, msg.fontName);
      } else if (msg.type === 'deselect-font') {
        // Clear selected state when deselected in Figma
        if (selectedFontItem) {
          selectedFontItem.classList.remove('selected');
          selectedFontItem = null;
        }
      }
    };
    
    function showNotification(message, count, fontName) {
      const toast = document.getElementById('notificationToast');
      if (!toast) return;
      
      // Format the message with count highlighted if available
      let displayMessage = message;
      if (count > 0) {
        // Extract count and make it bold
        displayMessage = message.replace(/(\d+)/, '<span class="notification-count">$1</span>');
      }
      
      toast.innerHTML = displayMessage;
      toast.classList.add('show');
      
      // Auto-hide after 3 seconds
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    async function processFonts(figmaFonts, missingFonts, fontCounts) {
      try {
        const response = await fetch(`https://www.googleapis.com/webfonts/v1/webfonts?key=${API_KEY}`);
        const data = await response.json();
        const googleFontNames = new Set(data.items.map(f => f.family.toLowerCase()));

        // Create a map for quick count lookup
        const countMap = new Map();
        
        if (fontCounts && fontCounts.length > 0) {
          fontCounts.forEach(f => {
            countMap.set(f.name, f.count);
          });
        } else {
          // Fallback: if fontCounts not available, assume at least 1 occurrence per font
          figmaFonts.forEach(f => countMap.set(f, 1));
        }

        document.getElementById('loader').style.display = 'none';
        const container = document.getElementById('resultsContainer');
        container.innerHTML = '';

        if(figmaFonts.length === 0 && missingFonts.length === 0) {
            container.innerHTML = '<p style="margin-top:24px; color:#999; font-size:13px; text-align:center;">No text layers found.</p>';
            return;
        }

        // 1. Separate Missing Fonts
        const missingSet = new Set(missingFonts);
        const installedFonts = figmaFonts.filter(f => !missingSet.has(f));

        if (missingFonts.length > 0) renderSection(container, 'Missing Fonts', missingFonts, googleFontNames, true, countMap);

        // 2. Separate Installed Fonts into: Icons, Google, Local
        const iconMatches = [];
        const googleMatches = [];
        const localMatches = [];

        installedFonts.forEach(font => {
            const lowerName = font.toLowerCase();
            
            // Check logic: Is it an Icon? -> Is it Google? -> Else Local
            const isIcon = ICON_KEYWORDS.some(keyword => lowerName.includes(keyword));
            
            if (isIcon) {
                iconMatches.push(font);
            } else if (googleFontNames.has(lowerName)) {
                googleMatches.push(font);
            } else {
                localMatches.push(font);
            }
        });

        // 3. Render Sections
        if (iconMatches.length > 0) renderSection(container, 'Icon Fonts', iconMatches, googleFontNames, false, countMap);
        if (googleMatches.length > 0) renderSection(container, 'Google Fonts', googleMatches, googleFontNames, false, countMap);
        if (localMatches.length > 0) renderSection(container, 'Local / System Fonts', localMatches, googleFontNames, false, countMap);

      } catch (error) {
        console.error(error);
      }
    }

    function renderSection(container, title, fonts, googleSet, isMissing, countMap) {
      const header = document.createElement('div');
      header.className = 'section-header';
      
      let headerHTML = `<h3>${title} <span style="color: #999; font-weight: 400;">(${fonts.length})</span></h3>`;
      
      // ADD THE DISCLAIMER FOR MISSING FONTS HERE
      if (isMissing) {
        headerHTML += `<span class="header-disclaimer">(Download links only available for Google Fonts)</span>`;
        header.style.flexDirection = 'column';
        header.style.alignItems = 'flex-start';
      }

      header.innerHTML = headerHTML;
      
      // Add Download All button (Only if missing AND exists in Google)
      if (isMissing) {
        const downloadable = fonts.filter(f => googleSet.has(f.toLowerCase()));
        if(downloadable.length > 0) {
          const dlBtn = document.createElement('button');
          dlBtn.className = 'icon-btn';
          dlBtn.innerText = 'Download All';
          dlBtn.onclick = () => {
             if(confirm('Download ' + downloadable.length + ' fonts? You may need to allow popups.')) {
                 downloadable.forEach((f, i) => {
                     setTimeout(() => {
                        window.open(`https://fonts.google.com/download?family=${f.replace(/\s+/g, '+')}`);
                     }, i * 500);
                 });
             }
          };
          header.appendChild(dlBtn);
        }
      }
      container.appendChild(header);

      const ul = document.createElement('ul');
      ul.className = 'list';
      fonts.forEach(font => {
        const count = countMap.get(font);
        // If count is undefined, it means the font wasn't in the countMap - this shouldn't happen but fallback to 1
        const finalCount = count !== undefined && count !== null ? count : 1;
        ul.appendChild(createRow(font, googleSet.has(font.toLowerCase()), isMissing, finalCount));
      });
      container.appendChild(ul);
    }

    function createRow(fontName, isGoogle, isMissing, count) {
      const wrapper = document.createElement('li');
      wrapper.className = 'item-wrapper';

      const mainRow = document.createElement('div');
      mainRow.className = 'item';

      const nameDiv = document.createElement('div');
      nameDiv.className = 'font-name';
      const displayCount = count || 0;
      const countBadge = `<span style="color: #999; font-weight: 400; font-size: 12px; margin-left: 4px;">(${displayCount})</span>`;
      nameDiv.innerHTML = `${fontName}${countBadge} ${isMissing ? '<span class="badge-missing">Missing</span>' : ''}`;

      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'actions';

      const linkGroup = document.createElement('div');
      linkGroup.className = 'link-group';
      const encoded = fontName.replace(/\s+/g, '+');
      
      // Add replace button to link group
      const replaceBtn = document.createElement('button');
      replaceBtn.className = 'ext-link';
      replaceBtn.setAttribute('data-tooltip', 'Replace font');
      replaceBtn.style.cursor = 'pointer';
      replaceBtn.style.border = 'none';
      replaceBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M11.3333 2.66667L13.3333 4.66667L11.3333 6.66667" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M2.66667 4.66667H13.3333" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M4.66667 13.3333L2.66667 11.3333L4.66667 9.33333" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M13.3333 11.3333H2.66667" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      `;
      replaceBtn.onclick = () => {
        showReplaceModal(fontName);
      };
      
      if (isGoogle) {
        linkGroup.innerHTML = `
          <a href="https://fonts.google.com/download?family=${encoded}" class="ext-link" data-tooltip="Download font" target="_blank">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M7.99999 10.6667L4.66666 7.33341L5.59999 6.36675L7.33332 8.10008V2.66675H8.66666V8.10008L10.4 6.36675L11.3333 7.33341L7.99999 10.6667ZM3.99999 13.3334C3.63332 13.3334 3.31955 13.203 3.05866 12.9421C2.79777 12.6812 2.6671 12.3672 2.66666 12.0001V10.0001H3.99999V12.0001H12V10.0001H13.3333V12.0001C13.3333 12.3667 13.2029 12.6807 12.942 12.9421C12.6811 13.2034 12.3671 13.3339 12 13.3334H3.99999Z" fill="currentColor"/>
            </svg>
          </a>
          <a href="https://fonts.google.com/specimen/${encoded}" class="ext-link" data-tooltip="View in browser" target="_blank">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M13.0667 14L8.86667 9.8C8.53333 10.0667 8.15 10.2778 7.71667 10.4333C7.28333 10.5889 6.82222 10.6667 6.33333 10.6667C5.12222 10.6667 4.09733 10.2471 3.25867 9.408C2.42 8.56889 2.00044 7.544 2 6.33333C1.99956 5.12267 2.41911 4.09778 3.25867 3.25867C4.09822 2.41956 5.12311 2 6.33333 2C7.54356 2 8.56867 2.41956 9.40867 3.25867C10.2487 4.09778 10.668 5.12267 10.6667 6.33333C10.6667 6.82222 10.5889 7.28333 10.4333 7.71667C10.2778 8.15 10.0667 8.53333 9.8 8.86667L14 13.0667L13.0667 14ZM6.33333 9.33333C7.16667 9.33333 7.87511 9.04178 8.45867 8.45867C9.04222 7.87556 9.33378 7.16711 9.33333 6.33333C9.33289 5.49956 9.04133 4.79133 8.45867 4.20867C7.876 3.626 7.16756 3.33422 6.33333 3.33333C5.49911 3.33244 4.79089 3.62422 4.20867 4.20867C3.62644 4.79311 3.33467 5.50133 3.33333 6.33333C3.332 7.16533 3.62378 7.87378 4.20867 8.45867C4.79356 9.04356 5.50178 9.33511 6.33333 9.33333Z" fill="currentColor"/>
            </svg>
          </a>
        `;
      } else {
        linkGroup.innerHTML = `
          <a href="https://www.google.com/search?q=${encoded}+font" class="ext-link" data-tooltip="Search in browser" target="_blank">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M13.0667 14L8.86667 9.8C8.53333 10.0667 8.15 10.2778 7.71667 10.4333C7.28333 10.5889 6.82222 10.6667 6.33333 10.6667C5.12222 10.6667 4.09733 10.2471 3.25867 9.408C2.42 8.56889 2.00044 7.544 2 6.33333C1.99956 5.12267 2.41911 4.09778 3.25867 3.25867C4.09822 2.41956 5.12311 2 6.33333 2C7.54356 2 8.56867 2.41956 9.40867 3.25867C10.2487 4.09778 10.668 5.12267 10.6667 6.33333C10.6667 6.82222 10.5889 7.28333 10.4333 7.71667C10.2778 8.15 10.0667 8.53333 9.8 8.86667L14 13.0667L13.0667 14ZM6.33333 9.33333C7.16667 9.33333 7.87511 9.04178 8.45867 8.45867C9.04222 7.87556 9.33378 7.16711 9.33333 6.33333C9.33289 5.49956 9.04133 4.79133 8.45867 4.20867C7.876 3.626 7.16756 3.33422 6.33333 3.33333C5.49911 3.33244 4.79089 3.62422 4.20867 4.20867C3.62644 4.79311 3.33467 5.50133 3.33333 6.33333C3.332 7.16533 3.62378 7.87378 4.20867 8.45867C4.79356 9.04356 5.50178 9.33511 6.33333 9.33333Z" fill="currentColor"/>
            </svg>
          </a>
        `;
      }
      // Add replace button after setting innerHTML
      linkGroup.appendChild(replaceBtn);
      actionsDiv.appendChild(linkGroup);

      mainRow.appendChild(nameDiv);
      mainRow.appendChild(actionsDiv);

      // Make the entire item clickable to select all fonts (but not when clicking action buttons)
      mainRow.onclick = (e) => {
        // Don't trigger if clicking on action buttons or links
        if (!e.target.closest('.actions') && !e.target.closest('.ext-link') && !e.target.closest('a')) {
          // Remove selected state from previous item
          if (selectedFontItem) {
            selectedFontItem.classList.remove('selected');
          }
          
          // Add selected state to current item
          mainRow.classList.add('selected');
          selectedFontItem = mainRow;
          
          parent.postMessage({ pluginMessage: { type: 'select-font', font: fontName } }, '*');
        }
      };
      mainRow.style.cursor = 'pointer';
      
      wrapper.appendChild(mainRow);

      return wrapper;
    }
    
    // Modal Functions
    function showReplaceModal(fontName) {
      const modal = document.getElementById('replaceModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalContent = document.getElementById('modalContent');
      
      modalTitle.textContent = `Replace "${fontName}" font`;
      modalContent.innerHTML = '';
      
      // Create input row
      const inputRow = document.createElement('div');
      inputRow.className = 'replace-row';

      const inputWrapper = document.createElement('div');
      inputWrapper.className = 'input-wrapper';

      const input = document.createElement('input');
      input.className = 'replace-input';
      input.placeholder = 'Type system font name...';
      input.autocomplete = 'off';

      const suggestionsBox = document.createElement('div');
      suggestionsBox.className = 'suggestions-list';

      // Helper function to render suggestions
      const renderSuggestions = (query) => {
        suggestionsBox.innerHTML = '';
        const val = query.toLowerCase();

        const matches = val 
            ? systemFontsGlobal.filter(f => f.toLowerCase().includes(val)) 
            : systemFontsGlobal;

        if (matches.length > 0) {
            suggestionsBox.classList.add('show');
            matches.slice(0, 50).forEach(match => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = match;
                item.onclick = () => { 
                    input.value = match; 
                    suggestionsBox.classList.remove('show'); 
                };
                suggestionsBox.appendChild(item);
            });
        } else {
            suggestionsBox.classList.remove('show');
        }
      };

      input.addEventListener('focus', () => {
         renderSuggestions(input.value);
      });

      input.addEventListener('input', () => {
         renderSuggestions(input.value);
      });

      // Close suggestions when clicking outside
      document.addEventListener('click', function closeSuggestions(e) {
        if (!inputWrapper.contains(e.target)) {
          suggestionsBox.classList.remove('show');
        }
      });

      inputWrapper.appendChild(input);
      inputWrapper.appendChild(suggestionsBox);

      const applyBtn = document.createElement('button');
      applyBtn.className = 'apply-btn';
      applyBtn.textContent = 'Apply';
      applyBtn.onclick = () => {
        if (input.value) {
          closeReplaceModal();
          document.getElementById('loader').style.display = 'block';
          document.getElementById('loader').innerText = 'Replacing...';
          parent.postMessage({ pluginMessage: { type: 'replace-font', oldFont: fontName, newFont: input.value } }, '*');
        }
      };

      inputRow.appendChild(inputWrapper);
      inputRow.appendChild(applyBtn);
      modalContent.appendChild(inputRow);
      
      // Show modal
      modal.classList.add('show');
    }
    
    function closeReplaceModal() {
      const modal = document.getElementById('replaceModal');
      modal.classList.remove('show');
    }
    
    // Close modal handlers
    document.getElementById('modalClose').onclick = closeReplaceModal;
    document.getElementById('replaceModal').onclick = (e) => {
      // Close if clicking on overlay (not on modal container)
      if (e.target.id === 'replaceModal') {
        closeReplaceModal();
      }
    };
  </script>
</body>
</html>