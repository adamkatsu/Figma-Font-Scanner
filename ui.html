<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: blob: https://fonts.google.com https://fonts.gstatic.com https://gwfh.mranftl.com https://www.googleapis.com;">

  <style>
    * { box-sizing: border-box; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Inter, sans-serif; 
      padding: 0; 
      margin: 0;
      color: #000; 
      font-size: 13px; 
      background: #f6f6f6;
      line-height: 1.5;
    }
    
    /* Header Section */
    .header-section {
      text-align: center;
      padding: 24px 20px;
      margin: 8;
      border-radius: 8px;
      background-color: #f2f6ff;
      position: relative;
      overflow: hidden;
    }
    
    .header-section::before {
      content: '';
      position: absolute;
      bottom: -100px;
      left: 50%;
      transform: translateX(-50%);
      width: 500px;
      height: 200px;
      background: radial-gradient(ellipse at center top, rgba(100, 150, 255, 0.5) 0%, rgba(100, 150, 255, 0.15) 40%, transparent 100%);
      filter: blur(40px);
      pointer-events: none;
      z-index: 0;
    }
    
    .header-section > * {
      position: relative;
      z-index: 1;
    }
    
    h2 { 
      margin: 0 0 0 0; 
      font-size: 28px; 
      font-weight: 700;
      letter-spacing: -0.5px;
      color: #000;
    }
    
    .header-subtitle {
      font-size: 13px;
      color: #666;
      margin: 0 0 16px 0;
      font-weight: 400;
    }
    
    /* Global Buttons */
    button { 
      cursor: pointer; 
      border: none; 
      border-radius: 8px; 
      font-weight: 500; 
      transition: all 0.15s ease;
      font-family: inherit;
      font-size: 13px;
    }
    
    .primary-btn {
      background: #000; 
      color: #fff; 
      padding: 12px 32px; 
      font-weight: 600;
      letter-spacing: -0.1px;
      border-radius: 8px;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-width: 200px;
    }
    
    .primary-btn svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }
    .primary-btn:hover { 
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .primary-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    
    /* Headers */
    .section-header {
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      margin: 0 0 0 0; 
      padding-bottom: 4px;
    }
    
    h3 { 
      margin: 0; 
      font-size: 11px; 
      text-transform: uppercase; 
      color: #666;
      font-weight: 600;
    }
    
    /* Disclaimers for sections */
    .header-disclaimer {
      font-size: 11px; 
      color: #999; 
      margin-top: 6px; 
      font-weight: 400;
      text-transform: none;
      letter-spacing: 0;
    }

    /* List Items */
    .list { 
      list-style: none; 
      padding: 0; 
      margin: 0 0 24px 0;
      overflow: visible;
    }
    
    .item-wrapper { 
      transition: all 0.15s ease;
      overflow: visible;
    }
    
    .item-wrapper:hover {
      transform: translateY(-2px);
    }
    
    .item-wrapper:last-child {
      border-bottom: none;
    }
    
    .item {
      display: flex; 
      flex-direction: column;
      padding: 8px 8px; 
      border: 1px solid #F7F7F7;
      border-radius: 8px;
      margin-top: 4px;
      background-color: #ffffff;
      transition: all 0.15s ease;
      overflow: visible;
    }

    .item:hover {
      background-color: #ffffff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .item-main-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      cursor: pointer;
    }
    
    .item.selected {
      cursor: default;
      background-color: #ffffff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      position: relative;
      z-index: 100;
    }

    .font-name { 
      font-weight: 500; 
      font-size: 14px; 
      display: flex; 
      align-items: center; 
      gap: 8px;
      color: #000;
      letter-spacing: -0.2px;
      position: relative;
      padding-left: 4px;
      transition: color 0.15s ease, padding-left 0.2s ease;
      flex: 1;
    }

    .font-details {
      display: none;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
      color: #777;
      letter-spacing: 0;
      padding: 8px 0 0 0;
      width: 100%;
      position: relative;
      z-index: 1;
      overflow: visible;
    }

    .font-details.show {
      display: flex;
    }

    .font-detail-section-title:not(:first-child) {
      margin-top: 8px;
    }

    .font-detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: #F7F7F7;
      border: none;
      border-radius: 6px;
      overflow: visible;
      position: relative;
    }

    .font-detail-label {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .font-detail-value {
      font-weight: 500; 
      color: #000;
      font-size: 13px;
    }

    .font-detail-count {
      font-size: 11px;
      color: #999;
    }

    .font-detail-control {
      display: flex; 
      gap: 6px;
      align-items: center; 
    }

    .font-detail-input,
    .font-detail-select {
      padding: 6px 10px;
      border: 1px solid #E5E5E5;
      border-radius: 4px;
      font-size: 12px;
      font-family: inherit;
      background: #fff;
      color: #000;
      min-width: 100px;
    }

    .font-detail-input:focus,
    .font-detail-select:focus {
      outline: none;
      border-color: #000;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.05);
    }

    .font-detail-input {
      width: 80px;
    }

    .font-detail-btn {
      padding: 6px 12px;
      background: #000;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .font-detail-btn:hover {
      background: #333;
    }

    .font-detail-btn:active {
      transform: scale(0.95);
    }

    .font-detail-section-title {
      font-size: 10px;
      font-weight: 600;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 0 0 4px 0;
    }
    
    .dropdown-icon {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
      transition: transform 0.2s ease, color 0.15s ease;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }
    
    .item-main-row:hover .dropdown-icon {
      color: #000;
    }
    
    .dropdown-icon.open {
      transform: rotate(90deg);
      color: #000;
    }
    
    .badge-missing { 
      background: rgba(255, 67, 67, 0.1); 
      color: #ff4343; 
      font-size: 10px; 
      padding: 3px 8px; 
      margin-left: 5px;
      border-radius: 4px;
      font-weight: 500;
      letter-spacing: 0.3px;
      text-transform: uppercase;
    }
    
    /* Action Buttons Row */
    .actions { 
      display: flex; 
      gap: 6px; 
      align-items: center;
      opacity: 1;
      transition: opacity 0.15s ease;
      padding-top: 2px;
    }
    
    .icon-btn {
      background: transparent; 
      border: 1px solid #E5E5E5; 
      color: #000;
      padding: 6px 12px; 
      font-size: 12px; 
      border-radius: 4px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .icon-btn svg {
      display: block;
    }
    
    .icon-btn:hover { 
      background: #000; 
      color: #fff;
      border-color: #000;
    }
    
    .icon-btn.active { 
      background: #000; 
      border-color: #000; 
      color: #fff; 
    }

    /* External Links */
    .link-group { 
      display: flex; 
      gap: 4px; 
    }
    
    .ext-link { 
      text-decoration: none; 
      color: #666; 
      font-weight: 400; 
      font-size: 16px;
      padding: 8px;
      border-radius: 4px;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      background: transparent;
    }
    
    .ext-link:hover { 
      color: #000;
      background: #e9e9e9;
    }
    
    .ext-link svg {
      width: 14px;
      height: 14px;
    }
    
    .ext-link.replace-active {
      color: #000;
      background: #e9e9e9;
    }
    
    /* Tooltip */
    .ext-link {
      position: relative;
    }
    
    .ext-link::before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-8px);
      background: #fff;
      color: #000;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 1001;
      margin-bottom: 4px;
      border: 1px solid #E5E5E5;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .ext-link::after {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-8px);
      border: 4px solid transparent;
      border-top-color: #fff;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 1002;
      margin-bottom: -4px;
      filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.05));
    }
    
    .ext-link:hover::before,
    .ext-link:hover::after {
      opacity: 1;
    }
    
    .ext-link:hover::before {
      transform: translateX(-50%) translateY(0);
    }
    
    .ext-link:hover::after {
      transform: translateX(-50%) translateY(0);
    }

    /* REPLACEMENT MODAL CSS */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .modal-overlay.show {
      display: flex;
      opacity: 1;
    }
    
    .modal-container {
      background: #fff;
      border-radius: 8px;
      padding: 24px;
      width: 90%;
      max-width: 320px;
      position: relative;
      transform: scale(0.95);
      transition: transform 0.2s ease;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      margin: auto;
    }
    
    .modal-overlay.show .modal-container {
      transform: scale(1);
      max-height: 85vh;
      overflow: visible;
    }
    
    /* LOADING OVERLAY CSS */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.95);
      z-index: 20000;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .loading-overlay.show {
      display: flex;
      opacity: 1;
    }
    
    .loading-content {
      text-align: center;
      padding: 32px;
    }
    
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #f0f0f0;
      border-top: 4px solid #0066FF;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-title {
      font-size: 15px;
      font-weight: 600;
      color: #000;
      margin-bottom: 8px;
    }
    
    .loading-progress {
      font-size: 13px;
      color: #666;
    }
    
    .modal-header {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .modal-title {
      font-size: 16px;
      font-weight: 600;
      color: #000;
      margin: 0;
      text-align: center;
      text-transform: none;
    }
    
    .modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      border-radius: 4px;
      transition: all 0.15s ease;
    }
    
    .modal-close:hover {
      background: #F5F5F5;
      color: #000;
    }
    
    .modal-close svg {
      width: 16px;
      height: 16px;
    }
    
    .replace-row { 
      display: flex; 
      flex-direction: column;
      gap: 16px; 
      position: relative; 
      overflow: visible;
    }
    
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      overflow: visible;
    }
    
    .input-group:first-child {
      padding-bottom: 16px;
      border-bottom: 1px solid #E5E5E5;
      position: relative;
    }
    
    .replace-divider-label {
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      padding: 0 8px;
      font-size: 10px;
      color: #999;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    
    .input-wrapper { 
      position: relative; 
      flex-grow: 1; 
      overflow: visible;
    }

    .replace-input {
      width: 100%; 
      box-sizing: border-box;
      padding: 10px 12px; 
      border: 1px solid #E5E5E5; 
      border-radius: 6px; 
      font-size: 13px;
      background: #fff;
      color: #000;
      font-family: inherit;
      transition: all 0.15s ease;
    }
    
    .replace-input:focus {
      outline: none;
      border-color: #000;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.05);
    }
    
    .replace-input::placeholder {
      color: #999;
    }
    
    .replace-input.readonly {
      background: #F9F9F9;
      color: #666;
      cursor: default;
      border-color: #E5E5E5;
    }

    .detail-section {
      margin-bottom: 20px;
    }

    .detail-title {
      font-size: 11px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: 6px;
    }

    .detail-list {
      border: 1px solid #E5E5E5;
      border-radius: 6px;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: #FBFBFB;
      max-height: 160px;
      overflow-y: auto;
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: #000;
    }

    .detail-value {
      font-weight: 500;
    }

    .detail-count {
      color: #777;
    }

    .detail-subtitle {
      font-size: 12px;
      font-weight: 600;
      color: #333;
      margin: 12px 0 6px;
      text-transform: none;
      letter-spacing: 0;
    }

    .detail-actions {
      display: flex;
      gap: 6px;
      margin-left: 8px;
    }

    .detail-action-btn {
      border: 1px solid #E5E5E5;
      border-radius: 4px;
      background: #fff;
      font-size: 11px;
      padding: 4px 8px;
      cursor: pointer;
      color: #000;
    }

    .detail-action-btn:hover {
      background: #000;
      color: #fff;
      border-color: #000;
    }

    .weight-picker {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .weight-picker-btn {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #E5E5E5;
      background: #fff;
      font-size: 13px;
      cursor: pointer;
      min-width: 80px;
      text-align: center;
    }

    .weight-picker-btn:hover {
      border-color: #000;
      background: #000;
      color: #fff;
    }

    .weight-picker-btn.current {
      background: #000;
      color: #fff;
      border-color: #000;
      cursor: default;
    }

    .detail-empty {
      text-align: center;
      color: #999;
      font-size: 13px;
      margin: 12px 0;
    }
    
    /* Font Size Pills */
    .size-pills-container {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 0px;
    }
    
    .size-pill {
      display: inline-flex;
      align-items: center;
      gap: 0px;
      padding: 6px 12px;
      background: #F7F7F7;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
      user-select: none;
      color: #000;
    }
    
    .size-pill:hover {
      background: #000000;
      color: #fff !important;
    }
    
    .size-pill.editing {
      background: #000000;
      color: #ffffff;
      cursor: default;
    }
    
    .size-pill.updating {
      opacity: 0.2;
      pointer-events: none;
    }
    
    .size-pill-value {
      font-weight: 500;
    }
    
    .size-pill-unit {
      font-weight: 500;
    }
    
    .size-pill-value[contenteditable="true"] {
      outline: none;
      cursor: text;
      user-select: text;
      padding: 0;
      color: #fff;
    }
    
    .size-pill-value[contenteditable="true"]:focus {
      background: transparent;
    }
    
    .size-pill-count {
      color: #999;
      font-weight: 400;
      margin-left: 4px;
    }
    
    .size-pill-apply {
      color: #ffffff;
      cursor: pointer;
      transition: all 0.15s ease;
      margin-left: 4px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
    }
    
    .size-pill-apply svg {
      width: 16px;
      height: 16px;
    }
    
    .size-pill-apply:hover {
      opacity: 0.7;
    }
    
    .replace-label {
      font-size: 11px;
      font-weight: 500;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: 6px;
      display: block;
    }

    /* CUSTOM SCROLLABLE LIST */
    .suggestions-list {
      position: absolute; 
      top: 100%; 
      left: 0; 
      right: 0;
      background: #fff; 
      border: 1px solid #E5E5E5; 
      border-top: none;
      border-radius: 0 0 6px 6px;
      max-height: 200px; 
      overflow-y: auto;
      z-index: 10001; 
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-top: -1px;
    }
    
    .suggestions-list.show { 
      display: block; 
    }
    
    .suggestion-item { 
      padding: 10px 12px; 
      cursor: pointer; 
      border-bottom: 1px solid #e9e9e9;
      color: #000;
      font-size: 13px;
      transition: background 0.1s ease;
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .suggestion-item:hover { 
      background: #FAFAFA; 
    }

    .apply-btn { 
      background: #000; 
      color: #fff; 
      padding: 10px 20px; 
      white-space: nowrap;
      font-weight: 500;
      border-radius: 4px;
    }
    
    .apply-btn:hover { 
      background: #333; 
    }
    
    .apply-btn:active {
      transform: scale(0.98);
    }

    .loader { 
      display: none; 
      text-align: center; 
      margin: 24px 0; 
      color: #666;
      font-size: 13px;
    }
    
    /* Container */
    #resultsContainer {
      padding: 0 0 0 0;
    }
    
    .content-wrapper {
      min-height: calc(100vh - 200px);
    }
    
    /* Empty state */
    #resultsContainer p {
      margin: 8px 0;
      color: #999;
      font-size: 13px;
      text-align: center;
    }
    
    /* Main container padding */
    body > *:not(script) {
      padding-left: 8px;
      padding-right: 8px;
    }
    
    /* Footer Section */
    .footer-section {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-top: 1px solid #E5E5E5;
      padding: 12px 20px;
      text-align: center;
      font-size: 11px;
      color: #999;
      z-index: 100;
    }
    
    .footer-content {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 3px;
      flex-wrap: wrap;
    }
    
    .footer-link {
      color: #000;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.15s ease;
    }
    
    .footer-link:hover {
      color: #666;
    }
    
    .footer-version {
      color: #999;
    }
    
    .footer-separator {
      color: #E5E5E5;
    }
    
    /* Content wrapper to prevent footer overlap */
    .content-wrapper {
      padding: 8px 8px 32px 8px;
    }
    
    /* Notification Toast */
    .notification-toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #fff;
      color: #000;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 500;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
      z-index: 10000;
      opacity: 0;
      transition: all 0.3s ease;
      display: inline-block;
      width: auto;
      min-width: fit-content;
      max-width: calc(100% - 32px);
      pointer-events: none;
      text-align: center;
      border: 1px solid #E5E5E5;
      white-space: nowrap;
    }
    
    .notification-toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
      pointer-events: auto;
    }
    
    .notification-toast .notification-count {
      font-weight: 600;
      margin-right: 4px;
    }
  </style>
</head>
<body>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-title">Replacing fonts...</div>
      <div class="loading-progress" id="loadingProgress">0/0</div>
    </div>
  </div>

  <div class="header-section">
  <h2>Font Scanner</h2>
    <p class="header-subtitle">Scan and manage fonts in your Figma designs</p>
    <button id="scanBtn" class="primary-btn">
      <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M2 4C2 2.89543 2.89543 2 4 2H6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M10 2H12C13.1046 2 14 2.89543 14 4V6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M14 10V12C14 13.1046 13.1046 14 12 14H10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M6 14H4C2.89543 14 2 13.1046 2 12V10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <rect x="5" y="5" width="6" height="6" stroke="currentColor" stroke-width="1.5" fill="none"/>
      </svg>
      Scan Fonts
    </button>
  </div>
  
  <div class="content-wrapper">
  <div id="loader" class="loader">Scanning...</div>
  <div id="resultsContainer"></div>
  </div>
  
  <div class="footer-section">
    <div class="footer-content">
      <span class="footer-version">v1.0.0</span>
      <span class="footer-separator">•</span>
      <span>Made with <span style="color: #ff6b6b;">♥</span> by</span>
      <a href="https://slabpixel.com" target="_blank" class="footer-link">SlabPixel</a>
    </div>
  </div>
  <div id="notificationToast" class="notification-toast"></div>
  
  <!-- Replace Modal -->
  <div id="replaceModal" class="modal-overlay">
    <div class="modal-container" id="modalContainer">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Replace Font</h3>
        <button class="modal-close" id="modalClose">
          <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      <div id="modalContent"></div>
    </div>
  </div>

  <script>
    const API_KEY = 'AIzaSyBZqOric7hC8x6zLV-Xt-X6VS0g6NsoA6k'; 
    let systemFontsGlobal = []; 
    let selectedFontItem = null; 
    let selectedFontName = null;
    let fontDetailsGlobal = {};
    let familyStylesGlobal = {};

    // KEYWORDS TO DETECT ICON FONTS
    const ICON_KEYWORDS = [
      'awesome', 'icon', 'symbol', 'glyph', 'icomoon', 'entypo', 'dingbat', 'ionicons', 'material icons', 'material symbols'
    ];

    const WEIGHT_KEYWORDS = [
      { weight: 100, tokens: ['thin', 'hairline'] },
      { weight: 200, tokens: ['extra light', 'extralight', 'ultra light', 'ultralight'] },
      { weight: 300, tokens: ['light'] },
      { weight: 350, tokens: ['book'] },
      { weight: 400, tokens: ['regular', 'normal', 'roman'] },
      { weight: 500, tokens: ['medium'] },
      { weight: 600, tokens: ['semibold', 'semi bold', 'demibold', 'demi bold'] },
      { weight: 700, tokens: ['bold'] },
      { weight: 800, tokens: ['extra bold', 'extrabold', 'ultra bold', 'ultrabold'] },
      { weight: 900, tokens: ['black', 'heavy'] }
    ];

    function getWeightMeta(style) {
      const value = (style || '').toString();
      const lower = value.toLowerCase();
      const isItalic = lower.includes('italic') || lower.includes('oblique');
      const numericMatch = lower.match(/(\d{3})/);
      let weight = numericMatch ? parseInt(numericMatch[1], 10) : null;
      if (!weight) {
        for (const entry of WEIGHT_KEYWORDS) {
          if (entry.tokens.some(token => lower.includes(token))) {
            weight = entry.weight;
            break;
          }
        }
      }
      return {
        weight: weight ?? 400,
        isItalic
      };
    }

    function splitWeightGroups(items, accessor = item => item) {
      const enriched = items.map(item => {
        const value = accessor(item);
        return {
          item,
          value,
          meta: getWeightMeta(value)
        };
      });

      enriched.sort((a, b) => {
        if (a.meta.weight !== b.meta.weight) {
          return a.meta.weight - b.meta.weight;
        }
        if (a.meta.isItalic !== b.meta.isItalic) {
          return Number(a.meta.isItalic) - Number(b.meta.isItalic);
        }
        return a.value.localeCompare(b.value);
      });

      return {
        normal: enriched.filter(entry => !entry.meta.isItalic),
        italic: enriched.filter(entry => entry.meta.isItalic)
      };
    }

    function restoreFontSelection(fontName) {
      // Find all font items and select the one matching the font name
      const allItems = document.querySelectorAll('.item');
      allItems.forEach(item => {
        const nameElement = item.querySelector('.font-name');
        if (nameElement && nameElement.textContent.includes(fontName)) {
          // Found the matching item
          item.classList.add('selected');
          selectedFontItem = item;
          selectedFontName = fontName;
          
          // Open the dropdown icon
          const dropdownIcon = item.querySelector('.dropdown-icon');
          if (dropdownIcon) dropdownIcon.classList.add('open');
          
          // Get isMissing status from the badge
          const isMissing = item.querySelector('.badge-missing') !== null;
          setInlineDetailsVisible(item, true, fontName, isMissing);
        }
      });
    }

    function performScan() {
      document.getElementById('resultsContainer').innerHTML = '';
      document.getElementById('loader').style.display = 'block';
      // Don't clear selected state - preserve the font name for restoration
      if (selectedFontItem) {
        selectedFontItem.classList.remove('selected');
        selectedFontItem = null;
        // Keep selectedFontName so it can be restored
      }
      parent.postMessage({ pluginMessage: { type: 'scan-layers' } }, '*');
    }
    
    document.getElementById('scanBtn').onclick = performScan;
    
    // Click outside to deselect font
    document.addEventListener('click', (e) => {
      // Check if click is outside of any .item
      if (!e.target.closest('.item') && !e.target.closest('.modal-overlay') && selectedFontItem) {
        setInlineDetailsVisible(selectedFontItem, false);
        selectedFontItem.classList.remove('selected');
        const dropdownIcon = selectedFontItem.querySelector('.dropdown-icon');
        if (dropdownIcon) dropdownIcon.classList.remove('open');
        selectedFontItem = null;
        selectedFontName = null;
        parent.postMessage({ pluginMessage: { type: 'deselect-font' } }, '*');
      }
    });
    
    // Automatically scan on plugin open
    performScan();

    onmessage = async (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'scan-result') {
        if (msg.systemFonts) systemFontsGlobal = msg.systemFonts;
        fontDetailsGlobal = msg.fontDetails || {};
        familyStylesGlobal = msg.familyStyles || {};
        
        // Store the currently selected font name before rebuilding
        const previouslySelectedFont = selectedFontName;
        
        await processFonts(
          msg.fonts || [],
          msg.missingFonts || [],
          msg.fontCounts || [],
          fontDetailsGlobal
        );
        
        // Restore selection if there was one
        if (previouslySelectedFont) {
          restoreFontSelection(previouslySelectedFont);
        }
      } else if (msg.type === 'notification') {
        showNotification(msg.message, msg.count, msg.fontName);
      } else if (msg.type === 'replacement-progress') {
        handleReplacementProgress(msg.current, msg.total, msg.fontName);
      } else if (msg.type === 'deselect-font') {
        // Clear selected state when deselected in Figma
        if (selectedFontItem) {
          setInlineDetailsVisible(selectedFontItem, false);
          selectedFontItem.classList.remove('selected');
          const dropdownIcon = selectedFontItem.querySelector('.dropdown-icon');
          if (dropdownIcon) dropdownIcon.classList.remove('open');
          selectedFontItem = null;
          selectedFontName = null;
        }
      }
    };
    
    function showNotification(message, count, fontName) {
      const toast = document.getElementById('notificationToast');
      if (!toast) return;
      
      // Format the message with count highlighted if available
      let displayMessage = message;
      if (count > 0) {
        // Extract count and make it bold
        displayMessage = message.replace(/(\d+)/, '<span class="notification-count">$1</span>');
      }
      
      toast.innerHTML = displayMessage;
      toast.classList.add('show');
      
      // Auto-hide after 3 seconds
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
    
    function handleReplacementProgress(current, total, fontName) {
      const overlay = document.getElementById('loadingOverlay');
      const progress = document.getElementById('loadingProgress');
      
      if (current === 0) {
        // Starting replacement - show overlay
        overlay.classList.add('show');
        progress.textContent = `0/${total}`;
      } else if (current >= total) {
        // Finished - hide overlay after a brief moment
        progress.textContent = `${total}/${total}`;
        setTimeout(() => {
          overlay.classList.remove('show');
        }, 500);
      } else {
        // Update progress
        progress.textContent = `${current}/${total}`;
      }
    }

    async function processFonts(figmaFonts, missingFonts, fontCounts, fontDetails = {}) {
      try {
        const response = await fetch(`https://www.googleapis.com/webfonts/v1/webfonts?key=${API_KEY}`);
        const data = await response.json();
        const googleFontNames = new Set(data.items.map(f => f.family.toLowerCase()));

        // Create a map for quick count lookup
        const countMap = new Map();
        
        if (fontCounts && fontCounts.length > 0) {
          fontCounts.forEach(f => {
            countMap.set(f.name, f.count);
          });
        } else {
          // Fallback: if fontCounts not available, assume at least 1 occurrence per font
          figmaFonts.forEach(f => countMap.set(f, 1));
        }

        document.getElementById('loader').style.display = 'none';
        const container = document.getElementById('resultsContainer');
        container.innerHTML = '';
        fontDetailsGlobal = fontDetails || {};

        if(figmaFonts.length === 0 && missingFonts.length === 0) {
            container.innerHTML = '<p style="margin-top:24px; color:#999; font-size:13px; text-align:center;">No text layers found.</p>';
            return;
        }

        // 1. Separate Missing Fonts
        const missingSet = new Set(missingFonts);
        const installedFonts = figmaFonts.filter(f => !missingSet.has(f));

        if (missingFonts.length > 0) renderSection(container, 'Missing Fonts', missingFonts, googleFontNames, true, countMap);

        // 2. Separate Installed Fonts into: Icons, Google, Local
        const iconMatches = [];
        const googleMatches = [];
        const localMatches = [];

        installedFonts.forEach(font => {
            const lowerName = font.toLowerCase();
            
            // Check logic: Is it an Icon? -> Is it Google? -> Else Local
            const isIcon = ICON_KEYWORDS.some(keyword => lowerName.includes(keyword));
            
            if (isIcon) {
                iconMatches.push(font);
            } else if (googleFontNames.has(lowerName)) {
                googleMatches.push(font);
            } else {
                localMatches.push(font);
            }
        });

        // 3. Render Sections
        if (googleMatches.length > 0) renderSection(container, 'Google Fonts', googleMatches, googleFontNames, false, countMap);
        if (localMatches.length > 0) renderSection(container, 'Local / System Fonts', localMatches, googleFontNames, false, countMap);
        if (iconMatches.length > 0) renderSection(container, 'Icon Fonts', iconMatches, googleFontNames, false, countMap);

      } catch (error) {
        console.error(error);
      }
    }

    function renderSection(container, title, fonts, googleSet, isMissing, countMap) {
      const header = document.createElement('div');
      header.className = 'section-header';
      
      let headerHTML = `<h3>${title} <span style="color: #999; font-weight: 400;">(${fonts.length})</span></h3>`;
      
      // ADD THE DISCLAIMER FOR MISSING FONTS HERE
      if (isMissing) {
        header.style.flexDirection = 'column';
        header.style.alignItems = 'flex-start';
      }

      header.innerHTML = headerHTML;
      
      // Add Download All button (Only if missing AND exists in Google)
      if (isMissing) {
        const downloadable = fonts.filter(f => googleSet.has(f.toLowerCase()));
        if(downloadable.length > 0) {
          const dlBtn = document.createElement('button');
          dlBtn.className = 'icon-btn';
          dlBtn.innerText = 'Download All';
          dlBtn.onclick = () => {
             if(confirm('Download ' + downloadable.length + ' fonts? You may need to allow popups.')) {
                 downloadable.forEach((f, i) => {
                     setTimeout(() => {
                        window.open(`https://fonts.google.com/download?family=${f.replace(/\s+/g, '+')}`);
                     }, i * 500);
                 });
             }
          };
          header.appendChild(dlBtn);
        }
      }
      container.appendChild(header);

      const ul = document.createElement('ul');
      ul.className = 'list';
      fonts.forEach(font => {
        const count = countMap.get(font);
        // If count is undefined, it means the font wasn't in the countMap - this shouldn't happen but fallback to 1
        const finalCount = count !== undefined && count !== null ? count : 1;
        ul.appendChild(createRow(font, googleSet.has(font.toLowerCase()), isMissing, finalCount));
      });
      container.appendChild(ul);
    }

    function createRow(fontName, isGoogle, isMissing, count) {
      const wrapper = document.createElement('li');
      wrapper.className = 'c';

      const mainRow = document.createElement('div');
      mainRow.className = 'item';

      // Create main row container for font name and actions
      const itemMainRow = document.createElement('div');
      itemMainRow.className = 'item-main-row';

      const nameDiv = document.createElement('div');
      nameDiv.className = 'font-name';
      const displayCount = count || 0;
      const countBadge = `<span style="color: #999; font-weight: 400; font-size: 12px; margin-left: 4px;">(${displayCount})</span>`;
      
      // Create dropdown triangle icon
      const dropdownIcon = document.createElement('div');
      dropdownIcon.className = 'dropdown-icon';
      dropdownIcon.innerHTML = `
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M5 3.5L8.5 7L5 10.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      `;
      
      nameDiv.appendChild(dropdownIcon);
      
      const nameText = document.createElement('span');
      nameText.innerHTML = `${fontName}${countBadge} ${isMissing ? '<span class="badge-missing">Missing</span>' : ''}`;
      nameDiv.appendChild(nameText);

      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'actions';

      const linkGroup = document.createElement('div');
      linkGroup.className = 'link-group';
      const encoded = fontName.replace(/\s+/g, '+');

      const appendLink = (href, tooltip, svgMarkup) => {
        const anchor = document.createElement('a');
        anchor.href = href;
        anchor.className = 'ext-link';
        anchor.setAttribute('data-tooltip', tooltip);
        anchor.target = '_blank';
        anchor.innerHTML = svgMarkup;
        linkGroup.appendChild(anchor);
      };

      if (isGoogle) {
        appendLink(
          `https://fonts.google.com/download?family=${encoded}`,
          'Download font',
          `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M7.99999 10.6667L4.66666 7.33341L5.59999 6.36675L7.33332 8.10008V2.66675H8.66666V8.10008L10.4 6.36675L11.3333 7.33341L7.99999 10.6667ZM3.99999 13.3334C3.63332 13.3334 3.31955 13.203 3.05866 12.9421C2.79777 12.6812 2.6671 12.3672 2.66666 12.0001V10.0001H3.99999V12.0001H12V10.0001H13.3333V12.0001C13.3333 12.3667 13.2029 12.6807 12.942 12.9421C12.6811 13.2034 12.3671 13.3339 12 13.3334H3.99999Z" fill="currentColor"/>
          </svg>`
        );
        appendLink(
          `https://fonts.google.com/specimen/${encoded}`,
          'View in browser',
          `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M13.0667 14L8.86667 9.8C8.53333 10.0667 8.15 10.2778 7.71667 10.4333C7.28333 10.5889 6.82222 10.6667 6.33333 10.6667C5.12222 10.6667 4.09733 10.2471 3.25867 9.408C2.42 8.56889 2.00044 7.544 2 6.33333C1.99956 5.12267 2.41911 4.09778 3.25867 3.25867C4.09822 2.41956 5.12311 2 6.33333 2C7.54356 2 8.56867 2.41956 9.40867 3.25867C10.2487 4.09778 10.668 5.12267 10.6667 6.33333C10.6667 6.82222 10.5889 7.28333 10.4333 7.71667C10.2778 8.15 10.0667 8.53333 9.8 8.86667L14 13.0667L13.0667 14ZM6.33333 9.33333C7.16667 9.33333 7.87511 9.04178 8.45867 8.45867C9.04222 7.87556 9.33378 7.16711 9.33333 6.33333C9.33289 5.49956 9.04133 4.79133 8.45867 4.20867C7.876 3.626 7.16756 3.33422 6.33333 3.33333C5.49911 3.33244 4.79089 3.62422 4.20867 4.20867C3.62644 4.79311 3.33467 5.50133 3.33333 6.33333C3.332 7.16533 3.62378 7.87378 4.20867 8.45867C4.79356 9.04356 5.50178 9.33511 6.33333 9.33333Z" fill="currentColor"/>
          </svg>`
        );
      } else {
        appendLink(
          `https://www.google.com/search?q=${encoded}+font`,
          'Search in browser',
          `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M13.0667 14L8.86667 9.8C8.53333 10.0667 8.15 10.2778 7.71667 10.4333C7.28333 10.5889 6.82222 10.6667 6.33333 10.6667C5.12222 10.6667 4.09733 10.2471 3.25867 9.408C2.42 8.56889 2.00044 7.544 2 6.33333C1.99956 5.12267 2.41911 4.09778 3.25867 3.25867C4.09822 2.41956 5.12311 2 6.33333 2C7.54356 2 8.56867 2.41956 9.40867 3.25867C10.2487 4.09778 10.668 5.12267 10.6667 6.33333C10.6667 6.82222 10.5889 7.28333 10.4333 7.71667C10.2778 8.15 10.0667 8.53333 9.8 8.86667L14 13.0667L13.0667 14ZM6.33333 9.33333C7.16667 9.33333 7.87511 9.04178 8.45867 8.45867C9.04222 7.87556 9.33378 7.16711 9.33333 6.33333C9.33289 5.49956 9.04133 4.79133 8.45867 4.20867C7.876 3.626 7.16756 3.33422 6.33333 3.33333C5.49911 3.33244 4.79089 3.62422 4.20867 4.20867C3.62644 4.79311 3.33467 5.50133 3.33333 6.33333C3.332 7.16533 3.62378 7.87378 4.20867 8.45867C4.79356 9.04356 5.50178 9.33511 6.33333 9.33333Z" fill="currentColor"/>
          </svg>`
        );
      }

      const replaceBtn = document.createElement('button');
      replaceBtn.className = 'ext-link';
      replaceBtn.type = 'button';
      replaceBtn.setAttribute('data-tooltip', 'Replace font');
      replaceBtn.style.cursor = 'pointer';
      replaceBtn.style.border = 'none';
      replaceBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M11.3333 2.66667L13.3333 4.66667L11.3333 6.66667" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M2.66667 4.66667H13.3333" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M4.66667 13.3333L2.66667 11.3333L4.66667 9.33333" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M13.3333 11.3333H2.66667" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      `;
      replaceBtn.onclick = (event) => {
        event.stopPropagation();
        showReplaceModal(fontName);
      };
      linkGroup.appendChild(replaceBtn);

      actionsDiv.appendChild(linkGroup);

      // Assemble the main row
      itemMainRow.appendChild(nameDiv);
      itemMainRow.appendChild(actionsDiv);

      // Create details section
      const detailsDiv = document.createElement('div');
      detailsDiv.className = 'font-details';

      // Append to main row
      mainRow.appendChild(itemMainRow);
      mainRow.appendChild(detailsDiv);

      // Make action buttons stop propagation to prevent triggering the dropdown
      actionsDiv.onclick = (e) => {
        e.stopPropagation();
      };
      
      // Handle item-main-row click to toggle details
      itemMainRow.onclick = (e) => {
        // Don't trigger if clicking on actions or links
        if (e.target.closest('.actions') || e.target.closest('.ext-link') || e.target.closest('a')) {
          return;
        }
        
        const isCurrentlySelected = mainRow.classList.contains('selected');
        
        if (isCurrentlySelected) {
          // Close details if already open
          setInlineDetailsVisible(mainRow, false);
          mainRow.classList.remove('selected');
          dropdownIcon.classList.remove('open');
          selectedFontItem = null;
          selectedFontName = null;
          parent.postMessage({ pluginMessage: { type: 'deselect-font' } }, '*');
        } else {
          // Close previous item if any
          if (selectedFontItem) {
            setInlineDetailsVisible(selectedFontItem, false);
            selectedFontItem.classList.remove('selected');
            const prevIcon = selectedFontItem.querySelector('.dropdown-icon');
            if (prevIcon) prevIcon.classList.remove('open');
          }
          
          // Open details for this item
          mainRow.classList.add('selected');
          dropdownIcon.classList.add('open');
          selectedFontItem = mainRow;
          selectedFontName = fontName;
          setInlineDetailsVisible(mainRow, true, fontName, isMissing);
          parent.postMessage({ pluginMessage: { type: 'select-font', font: fontName } }, '*');
        }
      };
      
      wrapper.appendChild(mainRow);

      return wrapper;
    }
    
    function setInlineDetailsVisible(row, shouldShow, fontName, isMissing) {
      const details = row.querySelector('.font-details');
      if (!details) return;
      if (!shouldShow) {
        details.classList.remove('show');
        details.innerHTML = '';
        return;
      }
      const fontData = fontDetailsGlobal[fontName];
      if (!fontData) {
        details.innerHTML = '<div style="color: #999; font-size: 12px; padding: 8px 0;">No usage data yet.</div>';
        details.classList.add('show');
        return;
      }
      if (isMissing) {
        details.innerHTML = '<div style="color: #999; font-size: 12px; padding: 0 0 8px 0;">Missing font - no details available.</div>';
        details.classList.add('show');
        return;
      }

      // Clear previous content
      details.innerHTML = '';
      
      // Get available styles for this font
      const availableStyles = familyStylesGlobal[fontName] || [];
      
      // Weights section
      const weights = fontData.styles || [];
      if (weights.length > 0) {
        
        weights.forEach(item => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'font-detail-item';
          
          const labelDiv = document.createElement('div');
          labelDiv.className = 'font-detail-label';
          
          const valueSpan = document.createElement('div');
          valueSpan.className = 'font-detail-value';
          valueSpan.textContent = item.value;
          
          const countSpan = document.createElement('div');
          countSpan.className = 'font-detail-count';
            countSpan.textContent = `${item.count} layer${item.count === 1 ? '' : 's'}`;

          labelDiv.appendChild(valueSpan);
          labelDiv.appendChild(countSpan);
          
          const controlDiv = document.createElement('div');
          controlDiv.className = 'font-detail-control';
          
          // Create dropdown for weight selection
          if (availableStyles.length > 0) {
            const select = document.createElement('select');
            select.className = 'font-detail-select';
            availableStyles.forEach(style => {
              const option = document.createElement('option');
              option.value = style;
              option.textContent = style;
              select.appendChild(option);
            });
            
            // Set the current weight as the selected value
            select.value = item.value;
            
            const applyBtn = document.createElement('button');
            applyBtn.className = 'font-detail-btn';
            applyBtn.textContent = 'Apply';
            applyBtn.onclick = () => {
              const newStyle = select.value;
              if (newStyle && newStyle !== item.value) {
                // Disable button and show loading state
                applyBtn.disabled = true;
                applyBtn.textContent = 'Applying...';
                applyBtn.style.opacity = '0.6';
                
                // Show toast notification
                showNotification(`Updating ${fontName} ${item.value} → ${newStyle}...`, 0);
                
                parent.postMessage({
                  pluginMessage: {
                    type: 'replace-font-weight',
                    family: fontName,
                    oldStyle: item.value,
                    newStyle: newStyle
                  }
                }, '*');
              }
            };
            
            controlDiv.appendChild(select);
            controlDiv.appendChild(applyBtn);
          }
          
          itemDiv.appendChild(labelDiv);
          itemDiv.appendChild(controlDiv);
          details.appendChild(itemDiv);
        });
      }
      
      // Sizes section
      const sizes = fontData.sizes || [];
      if (sizes.length > 0) {
        const sizesTitle = document.createElement('div');
        sizesTitle.className = 'font-detail-section-title';
        sizesTitle.textContent = 'Sizes';
        details.appendChild(sizesTitle);
        
        const pillsContainer = document.createElement('div');
        pillsContainer.className = 'size-pills-container';
        
        sizes.forEach(item => {
          // Format size to 2 decimal places if it has decimals
          const size = typeof item.value === 'number' ? 
            (Number.isInteger(item.value) ? item.value : parseFloat(item.value.toFixed(2))) : 
            item.value;
          
          const pill = document.createElement('div');
          pill.className = 'size-pill';
          
          const valueSpan = document.createElement('span');
          valueSpan.className = 'size-pill-value';
          valueSpan.textContent = size;
          
          const unitText = document.createElement('span');
          unitText.className = 'size-pill-unit';
          unitText.textContent = 'px';
          
          const countSpan = document.createElement('span');
          countSpan.className = 'size-pill-count';
          countSpan.textContent = `(${item.count})`;
          
          const applySpan = document.createElement('span');
          applySpan.className = 'size-pill-apply';
          applySpan.innerHTML = `
            <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M13.3333 4L6 11.3333L2.66667 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          `;
          applySpan.style.display = 'none';
          
          pill.appendChild(valueSpan);
          pill.appendChild(unitText);
          pill.appendChild(countSpan);
          pill.appendChild(applySpan);
          
          let isEditing = false;
          let originalValue = size;
          
          // Click handler to enable editing
          pill.onclick = (e) => {
            e.stopPropagation();
            
            if (!isEditing) {
              isEditing = true;
              pill.classList.add('editing');
              
              // Make value editable
              valueSpan.contentEditable = 'true';
              valueSpan.textContent = size.toString();
              
              // Show apply, hide count and unit
              unitText.style.display = 'none';
              countSpan.style.display = 'none';
              applySpan.style.display = 'inline';
              
              // Focus and select text
              valueSpan.focus();
              const range = document.createRange();
              range.selectNodeContents(valueSpan);
              const sel = window.getSelection();
              sel.removeAllRanges();
              sel.addRange(range);
            }
          };
          
          // Apply the change
          const applyChange = () => {
            const newValue = parseFloat(valueSpan.textContent);
            
            if (isNaN(newValue) || newValue <= 0) {
              // Invalid value, reset
              valueSpan.textContent = originalValue;
              cancelEdit();
              return;
            }
            
            if (newValue !== item.value) {
              // Update display immediately with new value
              isEditing = false;
              pill.classList.remove('editing');
              pill.classList.add('updating');
              valueSpan.contentEditable = 'false';
              
              // Format the new value for display
              const formattedNewValue = Number.isInteger(newValue) ? newValue : parseFloat(newValue.toFixed(2));
              valueSpan.textContent = formattedNewValue;
              originalValue = formattedNewValue;
              
              // Restore view mode UI
              unitText.style.display = 'inline';
              countSpan.style.display = 'inline';
              applySpan.style.display = 'none';
              
              // Send update message
              showNotification(`Updating ${fontName} ${item.value}px → ${newValue}px...`, 0);
              
              parent.postMessage({
                pluginMessage: {
                  type: 'replace-font-size',
                  family: fontName,
                  oldSize: item.value,
                  newSize: newValue
                }
              }, '*');
              
              // Remove updating state after a brief moment (scan will update the UI)
              setTimeout(() => {
                pill.classList.remove('updating');
              }, 500);
            } else {
              // No change, just cancel
              cancelEdit();
            }
          };
          
          const cancelEdit = () => {
            if (!isEditing) return;
            
            isEditing = false;
            pill.classList.remove('editing');
            valueSpan.contentEditable = 'false';
            valueSpan.textContent = originalValue;
            
            // Restore view mode
            unitText.style.display = 'inline';
            countSpan.style.display = 'inline';
            applySpan.style.display = 'none';
          };
          
          // Handle Enter key to apply
          valueSpan.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              applyChange();
            } else if (e.key === 'Escape') {
              e.preventDefault();
              cancelEdit();
            }
          });
          
          // Only allow numbers and decimal point
          valueSpan.addEventListener('input', (e) => {
            const text = valueSpan.textContent;
            const cleaned = text.replace(/[^\d.]/g, '');
            if (text !== cleaned) {
              valueSpan.textContent = cleaned;
              // Move cursor to end
              const range = document.createRange();
              const sel = window.getSelection();
              range.selectNodeContents(valueSpan);
              range.collapse(false);
              sel.removeAllRanges();
              sel.addRange(range);
            }
          });
          
          // Apply button click handler
          applySpan.onclick = (e) => {
            e.stopPropagation();
            applyChange();
          };
          
          // Cancel on blur (but not if clicking apply)
          valueSpan.addEventListener('blur', (e) => {
            // Small delay to allow apply click to register
            setTimeout(() => {
              if (isEditing && !e.relatedTarget) {
                cancelEdit();
              }
            }, 150);
          });
          
          pillsContainer.appendChild(pill);
        });
        
        details.appendChild(pillsContainer);
      }
      
      if (weights.length === 0 && sizes.length === 0) {
        details.innerHTML = '<div style="color: #999; font-size: 12px; padding: 8px 0;">No weights or sizes detected.</div>';
      }
      
      details.classList.add('show');
    }

    function showLoader(message) {
      const loader = document.getElementById('loader');
      if (!loader) return;
      loader.style.display = 'block';
      loader.innerText = message || 'Processing...';
    }

    function openValueReplaceModal(options) {
      const {
        title,
        currentLabel,
        placeholder,
        inputType = 'text',
        loadingText = 'Updating...',
        suggestions = null,
        onSubmit
      } = options;

      const modal = document.getElementById('replaceModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalContent = document.getElementById('modalContent');
      
      modalTitle.textContent = title || 'Replace';
      modalContent.innerHTML = '';
      
      // Create input row
      const inputRow = document.createElement('div');
      inputRow.className = 'replace-row';

      // Create "Before" input group (read-only)
      const beforeGroup = document.createElement('div');
      beforeGroup.className = 'input-group';
      
      const beforeInput = document.createElement('input');
      beforeInput.className = 'replace-input readonly';
      beforeInput.value = currentLabel || '';
      beforeInput.readOnly = true;
      
      const dividerLabel = document.createElement('span');
      dividerLabel.className = 'replace-divider-label';
      dividerLabel.textContent = 'Replace with';
      
      beforeGroup.appendChild(beforeInput);
      beforeGroup.appendChild(dividerLabel);
      
      // Create "After" input group (editable)
      const afterGroup = document.createElement('div');
      afterGroup.className = 'input-group';
      
      const inputWrapper = document.createElement('div');
      inputWrapper.className = 'input-wrapper';

      const input = document.createElement('input');
      input.className = 'replace-input';
      input.placeholder = placeholder || 'Enter value...';
      input.autocomplete = 'off';
      input.type = inputType;

      inputWrapper.appendChild(input);

      const suggestionSource = typeof suggestions === 'function' ? suggestions() : suggestions;
      if (Array.isArray(suggestionSource) && suggestionSource.length > 0) {
        const suggestionsBox = document.createElement('div');
        suggestionsBox.className = 'suggestions-list';

        const renderSuggestions = (query) => {
          suggestionsBox.innerHTML = '';
          const val = (query || '').toLowerCase();

          const matches = val
            ? suggestionSource.filter(f => f.toLowerCase().includes(val))
            : suggestionSource;

          if (matches.length > 0) {
            suggestionsBox.classList.add('show');
            matches.forEach(match => {
              const item = document.createElement('div');
              item.className = 'suggestion-item';
              item.textContent = match;
              item.onclick = () => {
                input.value = match;
                suggestionsBox.classList.remove('show');
              };
              suggestionsBox.appendChild(item);
            });
          } else {
            suggestionsBox.classList.remove('show');
          }
        };

        input.addEventListener('focus', () => renderSuggestions(input.value));
        input.addEventListener('input', () => renderSuggestions(input.value));

        const closeSuggestions = (e) => {
          if (!inputWrapper.contains(e.target)) {
            suggestionsBox.classList.remove('show');
            document.removeEventListener('click', closeSuggestions);
          }
        };
        document.addEventListener('click', closeSuggestions);
        inputWrapper.appendChild(suggestionsBox);
      }
      
      afterGroup.appendChild(inputWrapper);

      const applyBtn = document.createElement('button');
      applyBtn.className = 'apply-btn';
      applyBtn.textContent = 'Apply';
      applyBtn.onclick = () => {
        const value = input.value.trim();
        if (!value) {
          input.focus();
          return;
        }
        const shouldClose = onSubmit ? onSubmit(value) : true;
        if (shouldClose === false) {
          return;
        }
        closeReplaceModal();
        if (loadingText) {
          showLoader(loadingText);
        }
      };

      inputRow.appendChild(beforeGroup);
      inputRow.appendChild(afterGroup);
      inputRow.appendChild(applyBtn);
      modalContent.appendChild(inputRow);
      
      // Show modal
      modal.classList.add('show');
    }

    function showReplaceModal(fontName) {
      openValueReplaceModal({
        title: 'Replace Font',
        currentLabel: fontName,
        placeholder: 'Type font name...',
        loadingText: 'Replacing...',
        suggestions: () => systemFontsGlobal,
        onSubmit: (value) => {
          parent.postMessage({ pluginMessage: { type: 'replace-font', oldFont: fontName, newFont: value } }, '*');
          return true;
        }
      });
    }

    function showReplaceWeightModal(fontName, weightValue) {
      const availableStyles = familyStylesGlobal[fontName];
      if (!availableStyles || availableStyles.length === 0) {
        openValueReplaceModal({
          title: `Replace "${fontName}" weight`,
          currentLabel: weightValue,
          placeholder: 'e.g. Regular, Medium, Bold',
          loadingText: 'Updating weight...',
          onSubmit: (value) => {
            parent.postMessage({
              pluginMessage: {
                type: 'replace-font-weight',
                family: fontName,
                oldStyle: weightValue,
                newStyle: value
              }
            }, '*');
            return true;
          }
        });
        return;
      }

      const modal = document.getElementById('replaceModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalContent = document.getElementById('modalContent');

      modalTitle.textContent = `Choose a weight for ${fontName}`;
      modalContent.innerHTML = '';

      const info = document.createElement('p');
      info.style.fontSize = '13px';
      info.style.color = '#555';
      info.style.margin = '0 0 12px 0';
      info.textContent = 'Select an available style to replace the current weight.';
      modalContent.appendChild(info);

      const groups = splitWeightGroups(availableStyles, value => value);
      const currentLower = String(weightValue || '').toLowerCase();

      const renderGroup = (title, entries) => {
        if (entries.length === 0) return;
        const groupWrapper = document.createElement('div');
        groupWrapper.style.marginBottom = '16px';

        const subtitle = document.createElement('div');
        subtitle.className = 'detail-subtitle';
        subtitle.textContent = title;
        groupWrapper.appendChild(subtitle);

        const buttonRow = document.createElement('div');
        buttonRow.className = 'weight-picker';

        entries.forEach(entry => {
          const style = entry.value;
          const btn = document.createElement('button');
          btn.className = 'weight-picker-btn';
          if (style.toLowerCase() === currentLower) {
            btn.classList.add('current');
            btn.disabled = true;
          }
          btn.textContent = style;
          btn.onclick = () => {
            if (btn.disabled) return;
            closeReplaceModal();
            showLoader('Updating weight...');
            parent.postMessage({
              pluginMessage: {
                type: 'replace-font-weight',
                family: fontName,
                oldStyle: weightValue,
                newStyle: style
              }
            }, '*');
          };
          buttonRow.appendChild(btn);
        });

        groupWrapper.appendChild(buttonRow);
        modalContent.appendChild(groupWrapper);
      };

      renderGroup('Normal', groups.normal);
      renderGroup('Italic', groups.italic);

      modal.classList.add('show');
    }

    function showReplaceSizeModal(fontName, sizeValue) {
      const modal = document.getElementById('replaceModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalContent = document.getElementById('modalContent');
      
      // Format size for display
      const formattedSize = typeof sizeValue === 'number' ? 
        (Number.isInteger(sizeValue) ? sizeValue : parseFloat(sizeValue.toFixed(2))) : 
        sizeValue;
      
      modalTitle.textContent = 'Change Font Size';
      modalContent.innerHTML = '';
      
      // Create input row
      const inputRow = document.createElement('div');
      inputRow.className = 'replace-row';
      
      // Current size display
      const beforeGroup = document.createElement('div');
      beforeGroup.className = 'input-group';
      
      const beforeInput = document.createElement('input');
      beforeInput.className = 'replace-input readonly';
      beforeInput.value = `${formattedSize}px`;
      beforeInput.readOnly = true;
      
      const dividerLabel = document.createElement('span');
      dividerLabel.className = 'replace-divider-label';
      dividerLabel.textContent = 'Change to';
      
      beforeGroup.appendChild(beforeInput);
      beforeGroup.appendChild(dividerLabel);
      
      // New size input
      const afterGroup = document.createElement('div');
      afterGroup.className = 'input-group';
      
      const input = document.createElement('input');
      input.className = 'replace-input';
      input.type = 'number';
      input.placeholder = 'Enter new size';
      input.step = '0.01';
      input.min = '1';
      input.autocomplete = 'off';
      
      afterGroup.appendChild(input);
      
      // Apply button
      const applyBtn = document.createElement('button');
      applyBtn.className = 'apply-btn';
      applyBtn.textContent = 'Apply';
      applyBtn.onclick = () => {
        const newSize = parseFloat(input.value);
        if (isNaN(newSize) || newSize <= 0) {
          alert('Please enter a size greater than 0.');
          input.focus();
          return;
        }
        if (newSize === sizeValue) {
          alert('New size is the same as current size.');
          input.focus();
          return;
        }
        
        closeReplaceModal();
        showNotification(`Updating ${fontName} ${formattedSize}px → ${newSize}px...`, 0);
        
        parent.postMessage({
          pluginMessage: {
            type: 'replace-font-size',
            family: fontName,
            oldSize: sizeValue,
            newSize: newSize
          }
        }, '*');
      };
      
      // Allow Enter key to submit
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          applyBtn.click();
        }
      });
      
      inputRow.appendChild(beforeGroup);
      inputRow.appendChild(afterGroup);
      inputRow.appendChild(applyBtn);
      modalContent.appendChild(inputRow);
      
      // Show modal and focus input
      modal.classList.add('show');
      setTimeout(() => input.focus(), 100);
    }
    
    function closeReplaceModal() {
      const modal = document.getElementById('replaceModal');
      modal.classList.remove('show');
    }
    
    // Close modal handlers
    document.getElementById('modalClose').onclick = closeReplaceModal;
    document.getElementById('replaceModal').onclick = (e) => {
      // Close if clicking on overlay (not on modal container)
      if (e.target.id === 'replaceModal') {
        closeReplaceModal();
      }
    };
  </script>
</body>
</html>